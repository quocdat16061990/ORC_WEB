name: Deploy ORC App to VPS
on:
  push:
    branches: [ "main" ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy ORCWEB to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}      # 72.61.116.98
          username: ${{ secrets.VPS_USER }}  # root
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 15m
          script_stop: true
          script: |
            set -euo pipefail
            echo "üöÄ Deploying ORC app to VPS..."

            # 1) Pull code ORC_WEB
            cd /root/ORC_WEB
            git fetch --all -p
            git reset --hard origin/main

            # 2) Build & Up service orc-web (ƒë·∫£m b·∫£o d√πng ƒë√∫ng compose file)
            docker compose -f /root/docker-compose.yml build orc-web
            docker compose -f /root/docker-compose.yml up -d --remove-orphans orc-web

            # 3) Smoke test QUA TRAEFIK v·ªõi path "/"
            code=$(curl -sS -o /dev/null -w "%{http_code}" https://demoorcweb.shopabcquocdat.xyz/ || true)
            if [ "$code" -lt 200 ] || [ "$code" -ge 400 ]; then
              echo "‚ùå Smoke test FAIL (domain /): $code"
              echo "üîé Docker logs (orc-web):"
              docker compose -f /root/docker-compose.yml logs -n 120 orc-web || true
              echo "üîé Traefik logs (10m g·∫ßn nh·∫•t):"
              docker logs traefik --since 10m || true
              exit 1
            fi

            echo "‚úÖ Deployment completed successfully!"
